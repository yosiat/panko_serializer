<!doctype html>
<html lang="en" dir="ltr" class="docs-wrapper plugin-docs plugin-id-default docs-version-current docs-doc-page docs-doc-id-design-choices" data-has-hydrated="false">
<head>
<meta charset="UTF-8">
<meta name="generator" content="Docusaurus v3.9.2">
<title data-rh="true">Design Choices | Panko Serializers</title><meta data-rh="true" name="viewport" content="width=device-width,initial-scale=1"><meta data-rh="true" name="twitter:card" content="summary_large_image"><meta data-rh="true" property="og:image" content="https://panko.dev/img/undraw_online.svg"><meta data-rh="true" name="twitter:image" content="https://panko.dev/img/undraw_online.svg"><meta data-rh="true" property="og:url" content="https://panko.dev/design-choices"><meta data-rh="true" property="og:locale" content="en"><meta data-rh="true" name="docusaurus_locale" content="en"><meta data-rh="true" name="docsearch:language" content="en"><meta data-rh="true" name="docusaurus_version" content="current"><meta data-rh="true" name="docusaurus_tag" content="docs-default-current"><meta data-rh="true" name="docsearch:version" content="current"><meta data-rh="true" name="docsearch:docusaurus_tag" content="docs-default-current"><meta data-rh="true" property="og:title" content="Design Choices | Panko Serializers"><meta data-rh="true" name="description" content="In short, Panko is a serializer for ActiveRecord objects (it can&#x27;t serialize any other object), which strives for high performance &amp; simple API (which is inspired by ActiveModelSerializers)."><meta data-rh="true" property="og:description" content="In short, Panko is a serializer for ActiveRecord objects (it can&#x27;t serialize any other object), which strives for high performance &amp; simple API (which is inspired by ActiveModelSerializers)."><link data-rh="true" rel="icon" href="/favicon.ico"><link data-rh="true" rel="canonical" href="https://panko.dev/design-choices"><link data-rh="true" rel="alternate" href="https://panko.dev/design-choices" hreflang="en"><link data-rh="true" rel="alternate" href="https://panko.dev/design-choices" hreflang="x-default"><script data-rh="true" type="application/ld+json">{"@context":"https://schema.org","@type":"BreadcrumbList","itemListElement":[{"@type":"ListItem","position":1,"name":"Design Choices","item":"https://panko.dev/design-choices"}]}</script><link rel="stylesheet" href="/assets/css/styles.92503dd3.css">
<script src="/assets/js/runtime~main.62e94d9e.js" defer="defer"></script>
<script src="/assets/js/main.b4ccb795.js" defer="defer"></script>
</head>
<body class="navigation-with-keyboard">
<svg style="display: none;"><defs>
<symbol id="theme-svg-external-link" viewBox="0 0 24 24"><path fill="currentColor" d="M21 13v10h-21v-19h12v2h-10v15h17v-8h2zm3-12h-10.988l4.035 4-6.977 7.07 2.828 2.828 6.977-7.07 4.125 4.172v-11z"/></symbol>
</defs></svg>
<script>document.documentElement.setAttribute("data-theme","light"),document.documentElement.setAttribute("data-theme-choice","light"),function(){try{const c=new URLSearchParams(window.location.search).entries();for(var[t,e]of c)if(t.startsWith("docusaurus-data-")){var a=t.replace("docusaurus-data-","data-");document.documentElement.setAttribute(a,e)}}catch(t){}}()</script><div id="__docusaurus"><div role="region" aria-label="Skip to main content"><a class="skipToContent_fXgn" href="#__docusaurus_skipToContent_fallback">Skip to main content</a></div><nav aria-label="Main" class="theme-layout-navbar navbar navbar--fixed-top"><div class="navbar__inner"><div class="theme-layout-navbar-left navbar__items"><button aria-label="Toggle navigation bar" aria-expanded="false" class="navbar__toggle clean-btn" type="button"><svg width="30" height="30" viewBox="0 0 30 30" aria-hidden="true"><path stroke="currentColor" stroke-linecap="round" stroke-miterlimit="10" stroke-width="2" d="M4 7h22M4 15h22M4 23h22"></path></svg></button><a class="navbar__brand" href="/"><b class="navbar__title text--truncate">Panko Serializers</b></a><a class="navbar__item navbar__link" href="/introduction">Docs</a></div><div class="theme-layout-navbar-right navbar__items navbar__items--right"><div class="navbarSearchContainer_Bca1"></div></div></div><div role="presentation" class="navbar-sidebar__backdrop"></div></nav><div id="__docusaurus_skipToContent_fallback" class="theme-layout-main main-wrapper mainWrapper_z2l0"><div class="docsWrapper_hBAB"><button aria-label="Scroll back to top" class="clean-btn theme-back-to-top-button backToTopButton_sjWU" type="button"></button><div class="docRoot_UBD9"><aside class="theme-doc-sidebar-container docSidebarContainer_YfHR"><div class="sidebarViewport_aRkj"><div class="sidebar_njMd"><nav aria-label="Docs sidebar" class="menu thin-scrollbar menu_SIkG"><ul class="theme-doc-sidebar-menu menu__list"><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret menu__link--active" role="button" aria-expanded="true" href="/"><span title="Panko" class="categoryLinkLabel_W154">Panko</span></a></div><ul class="menu__list"><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/"><span title="Introduction" class="linkLabel_WmDU">Introduction</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/getting-started"><span title="Getting Started" class="linkLabel_WmDU">Getting Started</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link" tabindex="0" href="/performance"><span title="Performance" class="linkLabel_WmDU">Performance</span></a></li><li class="theme-doc-sidebar-item-link theme-doc-sidebar-item-link-level-2 menu__list-item"><a class="menu__link menu__link--active" aria-current="page" tabindex="0" href="/design-choices"><span title="Design Choices" class="linkLabel_WmDU">Design Choices</span></a></li></ul></li><li class="theme-doc-sidebar-item-category theme-doc-sidebar-item-category-level-1 menu__list-item menu__list-item--collapsed"><div class="menu__list-item-collapsible"><a class="categoryLink_byQd menu__link menu__link--sublist menu__link--sublist-caret" role="button" aria-expanded="false" href="/attributes"><span title="Reference" class="categoryLinkLabel_W154">Reference</span></a></div></li></ul></nav></div></div></aside><main class="docMainContainer_TBSr"><div class="container padding-top--md padding-bottom--lg"><div class="row"><div class="col docItemCol_VOVn"><div class="docItemContainer_Djhp"><article><nav class="theme-doc-breadcrumbs breadcrumbsContainer_Z_bl" aria-label="Breadcrumbs"><ul class="breadcrumbs"><li class="breadcrumbs__item"><a aria-label="Home page" class="breadcrumbs__link" href="/"><svg viewBox="0 0 24 24" class="breadcrumbHomeIcon_YNFT"><path d="M10 19v-5h4v5c0 .55.45 1 1 1h3c.55 0 1-.45 1-1v-7h1.7c.46 0 .68-.57.33-.87L12.67 3.6c-.38-.34-.96-.34-1.34 0l-8.36 7.53c-.34.3-.13.87.33.87H5v7c0 .55.45 1 1 1h3c.55 0 1-.45 1-1z" fill="currentColor"></path></svg></a></li><li class="breadcrumbs__item"><span class="breadcrumbs__link">Panko</span></li><li class="breadcrumbs__item breadcrumbs__item--active"><span class="breadcrumbs__link">Design Choices</span></li></ul></nav><div class="tocCollapsible_ETCw theme-doc-toc-mobile tocMobile_ITEo"><button type="button" class="clean-btn tocCollapsibleButton_TO0P">On this page</button></div><div class="theme-doc-markdown markdown"><header><h1>Design Choices</h1></header><p>In short, Panko is a serializer for ActiveRecord objects (it can&#x27;t serialize any other object), which strives for high performance &amp; simple API (which is inspired by ActiveModelSerializers).</p>
<p>Its performance is achieved by:</p>
<ul>
<li class=""><code>Oj::StringWriter</code> - I will elaborate later.</li>
<li class="">Type casting — instead of relying on ActiveRecord to do its type cast, Panko is doing it by itself.</li>
<li class="">Figuring out the metadata, ahead of time — therefore, we ask less questions during the <code>serialization loop</code>.</li>
</ul>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="serialization-overview">Serialization overview<a href="#serialization-overview" class="hash-link" aria-label="Direct link to Serialization overview" title="Direct link to Serialization overview" translate="no">​</a></h2>
<p>First, let&#x27;s start with an overview. Let&#x27;s say we want to serialize an <code>User</code> object, which has
<code>first_name</code>, <code>last_name</code>, <code>age</code>, and <code>email</code> properties.</p>
<p>The serializer definition will be something like this:</p>
<div class="language-ruby codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ruby codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">class</span><span class="token plain"> </span><span class="token class-name">UserSerializer</span><span class="token plain"> </span><span class="token operator" style="color:#393A34">&lt;</span><span class="token plain"> Panko</span><span class="token double-colon punctuation" style="color:#393A34">::</span><span class="token plain">Serializer</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  attributes </span><span class="token symbol" style="color:#36acaa">:name</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token symbol" style="color:#36acaa">:age</span><span class="token punctuation" style="color:#393A34">,</span><span class="token plain"> </span><span class="token symbol" style="color:#36acaa">:email</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">def</span><span class="token plain"> </span><span class="token method-definition function" style="color:#d73a49">name</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">    </span><span class="token string-literal string" style="color:#e3116c">&quot;</span><span class="token string-literal interpolation delimiter punctuation" style="color:#393A34">#{</span><span class="token string-literal interpolation content">object</span><span class="token string-literal interpolation content punctuation" style="color:#393A34">.</span><span class="token string-literal interpolation content">first_name</span><span class="token string-literal interpolation delimiter punctuation" style="color:#393A34">}</span><span class="token string-literal string" style="color:#e3116c"> </span><span class="token string-literal interpolation delimiter punctuation" style="color:#393A34">#{</span><span class="token string-literal interpolation content">object</span><span class="token string-literal interpolation content punctuation" style="color:#393A34">.</span><span class="token string-literal interpolation content">last_name</span><span class="token string-literal interpolation delimiter punctuation" style="color:#393A34">}</span><span class="token string-literal string" style="color:#e3116c">&quot;</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">  </span><span class="token keyword" style="color:#00009f">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token keyword" style="color:#00009f">end</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>And the usage of this serializer will be:</p>
<div class="language-ruby codeBlockContainer_Ckt0 theme-code-block" style="--prism-color:#393A34;--prism-background-color:#f6f8fa"><div class="codeBlockContent_QJqH"><pre tabindex="0" class="prism-code language-ruby codeBlock_bY9V thin-scrollbar" style="color:#393A34;background-color:#f6f8fa"><code class="codeBlockLines_e6Vv"><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># fetch user from database</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">user </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> User</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">first</span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># create serializer, with empty options</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">serializer </span><span class="token operator" style="color:#393A34">=</span><span class="token plain"> </span><span class="token class-name">UserSerializer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token keyword" style="color:#00009f">new</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain"></span><span class="token comment" style="color:#999988;font-style:italic"># serialize to JSON</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain">serializer</span><span class="token punctuation" style="color:#393A34">.</span><span class="token plain">serialize_to_json</span><span class="token punctuation" style="color:#393A34">(</span><span class="token plain">user</span><span class="token punctuation" style="color:#393A34">)</span><span class="token plain"></span><br></span><span class="token-line" style="color:#393A34"><span class="token plain" style="display:inline-block"></span><br></span></code></pre></div></div>
<p>Let&#x27;s go over the steps that Panko will execute behind the scenes for this flow.
<em>I will skip the serializer definition part, because it&#x27;s fairly simple and straightforward (see <code>lib/panko/serializer.rb</code>).</em></p>
<p>First step, while initializing the UserSerializer, we will create a <strong>Serialization Descriptor</strong> for this class.
Serialization Descriptor&#x27;s goal is to answer those questions:</p>
<ul>
<li class="">Which fields do we have? In our case, <code>:age</code>, <code>:email</code>.</li>
<li class="">Which method fields do we have? In our case <code>:name</code>.</li>
<li class="">Which associations do we have (and their serialization descriptors)?</li>
</ul>
<p>The serialization description is also responsible for filtering the attributes (<code>only</code> \ <code>except</code>).</p>
<p>Now, that we have the serialization descriptor, we are finished with the Ruby part of Panko, and all we did here is done in <em>initialization time</em> and now we move to C code.</p>
<p>In C land, we take the <code>user</code> object and the serialization descriptor, and start the serialization process which is separated to 4 parts:</p>
<ul>
<li class="">Serializing Fields - looping through serialization descriptor&#x27;s <code>fields</code> and read them from the ActiveRecord object (see <code>Type Casting</code>) and write them to the writer.</li>
<li class="">Serializing Method Fields - creating (a cached) serializer instance, setting its <code>@object</code> and <code>@context</code>, calling all the method fields and writing them to the writer.</li>
<li class="">Serializing associations — this is simple, once we have fields + method fields, we just repeat the process.</li>
</ul>
<p>Once this is finished, we have a nice JSON string.
Now let&#x27;s dig deeper.</p>
<h2 class="anchor anchorTargetStickyNavbar_Vzrq" id="interesting-parts">Interesting parts<a href="#interesting-parts" class="hash-link" aria-label="Direct link to Interesting parts" title="Direct link to Interesting parts" translate="no">​</a></h2>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="ojstringwriter">Oj::StringWriter<a href="#ojstringwriter" class="hash-link" aria-label="Direct link to Oj::StringWriter" title="Direct link to Oj::StringWriter" translate="no">​</a></h3>
<p>If you read the code of ActiveRecord serialization code in Ruby, you will observe this flow:</p>
<ol>
<li class="">Get an array of ActiveRecord objects (<code>User.all</code> for example).</li>
<li class="">Build a new array of hashes where each hash is an <code>User</code> with the attributes we selected.</li>
<li class="">The JSON serializer, takes this array of hashes and loop them, and converts it to a JSON string.</li>
</ol>
<p>This entire process is expensive in terms of Memory &amp; CPU, and this where the combination of Panko and Oj::StringWriter really shines.</p>
<p>In Panko, the serialization process of the above is:</p>
<ol>
<li class="">Get an array of ActiveRecord objects (<code>User.all</code> for example).</li>
<li class="">Create <code>Oj::StringWriter</code> and feed the values to it, via <code>push_value</code> / <code>push_object</code> / <code>push_object</code> and behind the scene, <code>Oj::StringWriter</code> will serialize the objects incrementally into a string.</li>
<li class="">Get from <code>Oj::StringWriter</code> the completed JSON string — which is a no-op, since <code>Oj::StringWriter</code> already built the string.</li>
</ol>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="figuring-out-the-metadata-ahead-of-time">Figuring out the metadata, ahead of time.<a href="#figuring-out-the-metadata-ahead-of-time" class="hash-link" aria-label="Direct link to Figuring out the metadata, ahead of time." title="Direct link to Figuring out the metadata, ahead of time." translate="no">​</a></h3>
<p>Another observation I noticed in the Ruby serializers is that they ask and do a lot in a serialization loop:</p>
<ul>
<li class="">Is this field a method? is it a property?</li>
<li class="">Which fields and associations do I need for the serializer to consider the <code>only</code> and <code>except</code> options?</li>
<li class="">What is the serializer of this has_one association?</li>
</ul>
<p>Panko tries to ask the bare minimum in serialization by building <code>Serialization Descriptor</code> for each serialization and caching it.</p>
<p>The Serialization Descriptor will do the filtering of <code>only</code> and <code>except</code> and will check if a field is a method or not (therefore Panko doesn&#x27;t have list of <code>attributes</code>).</p>
<h3 class="anchor anchorTargetStickyNavbar_Vzrq" id="type-casting">Type Casting<a href="#type-casting" class="hash-link" aria-label="Direct link to Type Casting" title="Direct link to Type Casting" translate="no">​</a></h3>
<p>This is the final part, which helped yield most of the performance improvements.
In ActiveRecord, when we read the value of an attribute, it does type casting of the DB value to its real Ruby type.</p>
<p>For example, time strings are converted to Time objects, Strings are duplicated, and Integers are converted from their values to Number.</p>
<p>This type casting is really expensive, as it&#x27;s responsible for most of the allocations in the serialization flow and most of them can be &quot;relaxed&quot;.</p>
<p>If we think about it, we don&#x27;t need to duplicate strings or convert time strings to time objects or even parse JSON strings for the JSON serialization process.</p>
<p>What Panko does is that if we have ActiveRecord type string, we won&#x27;t duplicate it.
If we have an integer string value, we will convert it to an integer, and the same goes for other types.</p>
<p>All of these conversions are done in C, which of course yields a big performance improvement.</p>
<h4 class="anchor anchorTargetStickyNavbar_Vzrq" id="time-type-casting">Time type casting<a href="#time-type-casting" class="hash-link" aria-label="Direct link to Time type casting" title="Direct link to Time type casting" translate="no">​</a></h4>
<p>While you read Panko source code, you will encounter the time type casting and immediately you will have a &quot;WTF?&quot; moment.</p>
<p>The idea behind the time type casting code relies on the end result of JSON type casting — what we need in order to serialize Time to JSON? UTC ISO8601 time format representation.</p>
<p>The time type casting works as follows:</p>
<ul>
<li class="">If it&#x27;s a string that ends with <code>Z</code>, and the strings matches the UTC ISO8601 regex, then we just return the string.</li>
<li class="">If it&#x27;s a string and it doesn&#x27;t follow the rules above, we check if it&#x27;s a timestamp in database format and convert it via regex + string concat to UTC ISO8601 - Yes, there is huge assumption here, that the database returns UTC timestamps — this will be configurable (before Panko official release).</li>
<li class="">If it&#x27;s none of the above, I will let ActiveRecord type casting do it&#x27;s magic.</li>
</ul></div></article><nav class="docusaurus-mt-lg pagination-nav" aria-label="Docs pages"><a class="pagination-nav__link pagination-nav__link--prev" href="/performance"><div class="pagination-nav__sublabel">Previous</div><div class="pagination-nav__label">Performance</div></a><a class="pagination-nav__link pagination-nav__link--next" href="/attributes"><div class="pagination-nav__sublabel">Next</div><div class="pagination-nav__label">Attributes</div></a></nav></div></div><div class="col col--3"><div class="tableOfContents_bqdL thin-scrollbar theme-doc-toc-desktop"><ul class="table-of-contents table-of-contents__left-border"><li><a href="#serialization-overview" class="table-of-contents__link toc-highlight">Serialization overview</a></li><li><a href="#interesting-parts" class="table-of-contents__link toc-highlight">Interesting parts</a><ul><li><a href="#ojstringwriter" class="table-of-contents__link toc-highlight">Oj::StringWriter</a></li><li><a href="#figuring-out-the-metadata-ahead-of-time" class="table-of-contents__link toc-highlight">Figuring out the metadata, ahead of time.</a></li><li><a href="#type-casting" class="table-of-contents__link toc-highlight">Type Casting</a></li></ul></li></ul></div></div></div></div></main></div></div></div><footer class="theme-layout-footer footer"><div class="container container-fluid"><div class="row footer__links"><div class="theme-layout-footer-column col footer__col"><div class="footer__title">GitHub</div><ul class="footer__items clean-list"><li class="footer__item"><a href="https://github.com/yosiat/panko_serializer" target="_blank" rel="noopener noreferrer" class="footer__link-item">Repository<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/yosiat/panko_serializer/discussions" target="_blank" rel="noopener noreferrer" class="footer__link-item">Discussions<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item"><a href="https://github.com/yosiat/panko_serializer/issues" target="_blank" rel="noopener noreferrer" class="footer__link-item">Issues<svg width="13.5" height="13.5" aria-label="(opens in new tab)" class="iconExternalLink_nPIU"><use href="#theme-svg-external-link"></use></svg></a></li><li class="footer__item">
                  <iframe src="https://ghbtns.com/github-btn.html?user=yosiat&amp;repo=panko_serializer&amp;type=star&amp;count=true&amp;size=medium" title="GitHub Stars"></li></ul></div></div><div class="footer__bottom text--center"><div class="footer__copyright">Copyright © 2025 Panko Serializer</div></div></div></footer></div>
</body>
</html>